{% extends "base.html" %} {% load staticfiles %} {% block title %} 登录 {% endblock title %} {% block css %}
<style>
    body {
        background: #eee;
        color: #555;
        font-family: 'Microsoft YaHei', "PingFang SC", "Microsoft YaHei", sans-serif;
        font-size: .9em;
        line-height: 2;
    }
    .card-img {
        margin: 10px;
        width: 100%;
        height: 100px;
        border-width: 0;
        border-radius: 7px;
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
        background-color: #2D2B29;
    }
    .coin {
        margin: 10px;
        width: 150%;
    }
</style>
{% endblock css %} {% block content %}

<div class="container">
    <div class="row">
        <div class="col-sm-12 mt-5">
            <div class="row">
                <div class="col-sm-2" id="player5">
                    {% include "player-base2.html" %}
                </div>
                <div class="col-sm-2 offset-sm-3" id="player6">
                    {% include "player-base2.html" %}
                </div>
                <div class="col-sm-2 offset-sm-3" id="player7">
                    {% include "player-base2.html" %}
                </div>
            </div>
            <div class="row mt-3 mb-3">
                <div class="col-sm-2">
                    <div class="mb-3" id="player4">
                        {% include "player-base2.html" %}
                    </div>
                    <div id="player3">
                        {% include "player-base2.html" %}
                    </div>
                </div>
                <div class="col-sm-6 offset-sm-1">
                    <div class="row mt-5 mb-5">
                        <div class="col-sm-1 offset-sm-5">
                            <img class="coin" id="b1" src="{% static 'images/chip.svg' %}">
                        </div>
                        <div class="col-sm-2 pt-2">
                            <h5 id="desktop-money"></h5>
                        </div>
                    </div>
                    <div class="row mb-5">
                        <div class="col-sm-2 offset-sm-1">
                            <img class="card-img" id="d0" src="{% static 'images/poker/NO.svg' %}">
                        </div>
                        <div class="col-sm-2">
                            <img class="card-img" id="d1" src="{% static 'images/poker/NO.svg' %}">
                        </div>
                        <div class="col-sm-2">
                            <img class="card-img" id="d2" src="{% static 'images/poker/NO.svg' %}">
                        </div>
                        <div class="col-sm-2">
                            <img class="card-img" id="d3" src="{% static 'images/poker/NO.svg' %}">
                        </div>
                        <div class="col-sm-2">
                            <img class="card-img" id="d4" src="{% static 'images/poker/NO.svg' %}">
                        </div>
                    </div>
                </div>
                <div class="col-sm-2 offset-sm-1">
                    <div class="mb-3" id="player8">
                        {% include "player-base2.html" %}
                    </div>
                    <div id="player9">
                        {% include "player-base2.html" %}
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-2" id="player2">
                    {% include "player-base2.html" %}
                </div>
                <div class="col-sm-2 offset-sm-3" id="player1">
                    {% include "player-base2.html" %}
                    <row>
                        <button style="display:none" class="col-sm-12 btn btn-sm btn-primary mt-3 mb-3" type="submit" id="next">next game</button>  
                    </row>
                </div>
                <div class="col-sm-2 offset-sm-3" id="player10">
                    {% include "player-base2.html" %}
                </div>
            </div>             
        </div>
    </div>
</div>
{% endblock content %}
{% block js %}
<script>
    var personPosition = [[], ['1'], ['1', '6'], ['1', '4', '6'], ['1', '4', '6', '8'], ['1', '3', '4', '6', '8'],
                           ['1', '3', '4', '6', '8', '9'], ['1', '3', '4', '5', '6', '8', '9'], 
                           ['1', '3', '4', '5', '6', '7', '8', '9'], ['1', '2', '3', '4', '5', '6', '8', '7', '9'], 
                           ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10']];
    var maxPeople = 0;
    var socket = new WebSocket("ws://" + window.location.href.split("//")[1] + "ws/");
    socket.onmessage = function (e) {
        var data = JSON.parse(e.data);
        console.log(data);
        if (data.info == 'state' && data.action_history[0].length == 0)
        {
            gameReset(data);
        }
        if (data.info == 'state')
        {
            setDesktopCard(data.public_card);
            setDesktopMoney(data.desktop_money);
            setActionStatus(data.action_position);
            for (var i = 0; i < maxPeople; ++i)
            {
                setName(data.name[i], i);
                setPlayerCard(data.player_card[i], i);
                setPlayerMoney(data.money[i], i);
                setRaiseMoney(data.round_raise[i], i)
            }
            if (data.action_player !== "")
            {
                setPlayerAction(data.current_action, data.action_player);
            }
        }
        if (data.info == 'state' && data.action_history[data.action_history.length - 1].length == 0 && data.action_history[0].length != 0)
        {
            roundReset();
        }
        if (data.info == 'result')
        {   
            init(data);
            for (var i = 0; i < maxPeople; ++i)
            {
                setTotalMoney(data.total_money[i], i);
                setWinner(data.win_money[i], i);
                setTotalTask(data.times[i], i)
            }
            setDesktopCard(data.public_card);
        } 
    }
    function roundReset() {
        for (var i of personPosition[maxPeople])
        { 
            if ($("#player" + String(i) + " .status").text() != 'fold' && $("#player" + String(i) + " .status").text() != 'Action')
            {
                $("#player" + String(i) + " .status").text('');
            }
            $("#player" + String(i) + " .cur-raise").text(0);
        }
    }
    function setActionStatus(position) {
        var seat = personPosition[maxPeople][position];
        var line = $("#player" + String(seat) + " .status");
        line.text('Action');
    }
    function setTotalTask(total_task, position) {
        var seat = personPosition[maxPeople][position];
        $("#player" + String(seat) + " .total-task").text(total_task);
    }
    function setTotalMoney(total_money, position) {
        var seat = personPosition[maxPeople][position];
        $("#player" + String(seat) + " .win-money").text(total_money);
    }
    function setWinner(win_money, position) {
        var seat = personPosition[maxPeople][position];
        var line = $("#player" + String(seat) + " .status");
        if (win_money > 0)
            line.text('Win!');
        else
            line.text('');
    }
    function init(data) {
        maxPeople = data.name.length;
        for (var i of personPosition[maxPeople])
            $("#player" + String(i) + " .row").css("visibility", "visible");
    }
    function gameReset(data) {
        for (var i of personPosition[maxPeople])
        {
            $("#player" + String(i) + " .money").text(20000);
            $("#player" + String(i) + " .cur-raise").text(0);
            $("#player" + String(i) + " .status").text('');
            for (var j = 0; j < 2; ++j)
            {
                $("#player" + String(i) + " .card" + String(j)).attr('src', "/static/images/poker/NO.svg");
            }
        }
        $("#player" + String(personPosition[maxPeople][0]) + " .money").text(19950);
        $("#player" + String(personPosition[maxPeople][1]) + " .money").text(19900);
        $("#player" + String(personPosition[maxPeople][0]) + " .cur-raise").text(50);
        $("#player" + String(personPosition[maxPeople][1]) + " .cur-raise").text(100);
        setDesktopMoney(0);
        for (var i = 0; i < 5; ++i)
        {
            $("#d" + String(i)).attr('src', "/static/images/poker/NO.svg"); 
        }
    }
    function setPlayerAction(action, position) {
        var seat = personPosition[maxPeople][position];
        $("#player" + String(seat) + " .status").text(action);
    }
    function displayBlock() {
        for (var i of personPosition[maxPeople])
        {
            $("#player" + String(i) + " .row").css("visibility", "visible");
        }
    }
    function setName(name, position) {
        var seat = personPosition[maxPeople][position];
        $("#player" + String(seat) + " .name").text(name);
    }
    function setPlayerCard(card, position) {
        var seat = personPosition[maxPeople][position];
        var line = $("#player" + String(seat));
        for (var i = 0; i < card.length; ++i)
        {
            line.find(".card" + String(i)).attr('src', "/static/images/poker/" + card[i] + ".svg");
        }
    }
    function setRaiseMoney(money, position) {
        var seat = personPosition[maxPeople][position];
        $("#player" + String(seat) + " .cur-raise").text(money);
    }
    function setPlayerMoney(money, position) {
        var seat = personPosition[maxPeople][position];
        $("#player" + String(seat) + " .money").text(money);
    }
    function setDesktopCard(desktopCard) {
        for (var i = 0; i < desktopCard.length; ++i)
        {
            $("#d" + String(i)).attr('src', "/static/images/poker/" + desktopCard[i] + ".svg"); 
        }
    }; 
    function setDesktopMoney(total) {
        $("#desktop-money").text(String(total));
    }
</script>
{% endblock js %}